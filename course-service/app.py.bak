from flask import Flask, request, jsonify
from flask_cors import CORS
import psycopg2
import os

app = Flask(__name__)
CORS(app)

DATABASE_URL = os.getenv('DATABASE_URL', 'postgresql://scaler_admin:VulnerablePassword123!@postgres:5432/scaler_db')

def get_db_connection():
    return psycopg2.connect(DATABASE_URL)

@app.route('/health', methods=['GET'])
def health():
    return jsonify({"status": "OK"}), 200

@app.route('/api/v1/courses', methods=['GET'])
def get_courses():
    search = request.args.get('search', '')
    conn = get_db_connection()
    cur = conn.cursor()
    
    if search:
        query = f"SELECT * FROM courses WHERE title LIKE '%{search}%'"
        cur.execute(query)
    else:
        cur.execute("SELECT * FROM courses")
    
    courses = cur.fetchall()
    cur.close()
    conn.close()
    
    result = []
    for course in courses:
        result.append({
            'id': course[0],
            'title': course[1],
            'description': course[2],
            'instructor_id': course[3],
            'price': float(course[4]),
            'created_at': str(course[5])
        })
    
    return jsonify(result), 200

@app.route('/api/v1/courses/<int:course_id>', methods=['GET'])
def get_course(course_id):
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute("SELECT * FROM courses WHERE id = %s", (course_id,))
    course = cur.fetchone()
    cur.close()
    conn.close()
    
    if course:
        return jsonify({
            'id': course[0],
            'title': course[1],
            'description': course[2],
            'instructor_id': course[3],
            'price': float(course[4]),
            'created_at': str(course[5])
        }), 200
    return jsonify({'error': 'Course not found'}), 404

@app.route('/api/v1/enrollments', methods=['POST'])
def create_enrollment():
    data = request.get_json()
    student_id = data.get('student_id')
    course_id = data.get('course_id')
    
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute(
        "INSERT INTO enrollments (student_id, course_id) VALUES (%s, %s) RETURNING id",
        (student_id, course_id)
    )
    enrollment_id = cur.fetchone()[0]
    conn.commit()
    cur.close()
    conn.close()
    
    return jsonify({
        'id': enrollment_id,
        'student_id': student_id,
        'course_id': course_id,
        'status': 'active'
    }), 201

@app.route('/api/v1/students/<int:student_id>/grades', methods=['GET'])
def get_student_grades(student_id):
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute("""
        SELECT s.id, a.title, s.score, s.submitted_at, c.title as course_title
        FROM submissions s
        JOIN assignments a ON s.assignment_id = a.id
        JOIN courses c ON a.course_id = c.id
        WHERE s.student_id = %s
    """, (student_id,))
    grades = cur.fetchall()
    cur.close()
    conn.close()
    
    result = []
    for grade in grades:
        result.append({
            'submission_id': grade[0],
            'assignment': grade[1],
            'score': grade[2],
            'submitted_at': str(grade[3]),
            'course': grade[4]
        })
    
    return jsonify(result), 200

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8081, debug=True)
